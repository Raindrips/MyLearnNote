# cocos2d网络通信

cocos2d封装了三个网络接口

1. HttpRequest
2. HttpClient
3. HttpResponse

### Socket通信

网络俗称套接字,本身不是协议,而是一个调用接口,对TCP/IP协议的封装.提供了函数对开发者进行使用

TCP/IP协议是传输层协议,主要解决数据如何在网络中进行传输

Socket 分为数据报模式和流模式,即TCP与UDP两种模式

- TCP: Transmission Control Protocol 传输控制协议,是面向连接的协议,是一种靠的数据连接方式,在收发数据前要经过负责的传输进行连接
- UDP:直接将数据发送到网络,接收端把消息放到队列中,应用程式

`WebSocket `protocol协议

`HTML5`一种新的协议.实现浏览器和服务器的即使通讯

## Cocos2d-x 封装的网络库

- `HttpRequest`
- `HttpClient`
- `HttpResponse`



请求过程

1. 创建HttpRequest的实例
2. 设置请求方式，GET,POST等
3. 设置请求的发送数据
4. 设置响应回调函数，在回调函数中处理获取的数据
5. 释放连接

## HttpRequest对象

该类是一种数据类型,提供了一些方法来获取http对象

头文件

```cpp
#include <network\HttpRequest.h>
using namespace network;
```

#### 请求过程

1. 创建`HttpRequest`的实例
2. 设置请求方式 GET,POST
3. 设置请求地址和发送数据
4. 设置响应回调函数,在回调函数中处理获取的数据
5. 创建HttpClient实例,发送请求
6. 释放连接

```cpp
//Http请求对象
class HttpRequest{
    enum class Type{
        GET,
        POST,
        PUT,
        DELETE,
        UNKNOWN,
    };
    //设置请求连接 
    void setUrl(const char* url);
    //设置标签
    void setTag(const char* tag);
    //设置请求类型 
    void setRequestType(Type type);
     //设置请求的数据
    void setRequestData(const char* buffer, unsigned int len);
    //设置请求回调函数
    void setResponseCallback();
    
    //使用完成后使用函数释放
    void release();
};
```



## HttpClient对象

客户端用来控制请求的相关参数,比如发送请求,设置请求超时时间.

头文件 

```cpp
#include <network/HttpClient.h>
using namespace network;
```

常用方法

```cpp
//
class HttpClient{
    static HttpClient* getInstance();
    //发送请求
    void send(HttpRequest* http);
    //设置连接超时时间
    void setTimeoutForConnect(int value);
    //设置连接超时时间
    void setTimeoutForRead(int value);
};
```

## HttpResponse

头文件

```cpp
#include <netwrok/HttpResponse.h>
using namespace HttpResponse;
```

该类包含服务器数据信息,可以获取数据

```cpp
//包含服务器返回的数据等
class HttpResponse{
    //获取请求返回的数据
    std::vector<char*>* getResponseData();

    //获取错误返回状态
    int getResponceState();
    //判断是否连接成功
    bool isSucced();
    
    //
    int getResponseCode();
    
    const char* getErrorBuffer(); 
};
```



示例:

```cpp
//使用http请求
auto request = new HttpRequest();
//设置域名
request->setUrl("http://www.baidu.com");
//设置标签
request->setTag("type get");
//设置请求类型
request->setRequestType(HttpRequest::Type::GET);
//发送数据
string str="hello world";
request->setRequestData(str.data(),str.size());

//创建httpClinet对象
auto client = HttpClient::getInstance();
client->setTimeoutForConnect(60);
client->send(request); 

//接收数据
if(response->isSucceed()){
    auto data=response->getResponseData();
    for(auto e:data){
        
    }
}else{
 	   
}

delete request;
```

使用Post发送数据

```cpp
auto request = new HttpRequest();
request->setUrl("http://www.baidu.com");
request->setTag("type post");
request->setRequestType(HttpRequest::Type::POST);
string reqData="visiter=cocos2d&action=test";
request->setRequestData(reqData.data(),reqData.size());

```



### 

## webSocked

通信过程

1. IP地址
2. 端口号
3. 连接链路



使用需要引入头文件

```cpp
#include "network\WebSocket.h"
using namespace cocos2d::network;
```

生命周期委托接口

```cpp
//虚基类
class WebSocked::Delegate{
    //打开时调用
    void onOpen(WebSocked* ws);
	//接收到数据时调用
    void onMessage(WebSocked *ws,const Data& data);
    //当关闭连接时
    void onClose(WebSocket* ws);
    //当发送数据时没有建立连接,或是信号断开时调用 
    void onError(WebSocket* ws,const ErrorCode& error);
}
```

创建对象

```cpp
WebSocket* socket=new WebSocket();
```

初始化请求地址

```cpp
//初始化请求地址
socket->init(void* obj,"http://www.123.com");
//发送数据
socket->send("hello text");
```

## rapidjson

该对象可以读取和修改数据,和删除数据

头文件

```cpp
#include "cocos2d/external/json/rapidjson.h
```

使用

```cpp
//创建文档对象
rapidjson::Document doc;

//获取分配器
rapidjson::Document::AllocatorType &allocate=doc.GetAllocator();

//添加数据
doc->AddMenber("age",15,allocate);
```

### 读取和更改数据

```cpp
//值类型
rapidjson::Value value;

//通过key获取值
value=doc["key"];
```



### json转换

```cpp
//字符串
rapidjson::StringBuffer buffer;

//写入
rapidjson::Writer<rapidjson::StringBuffer> write;

//
doc.Accept(write);

string str=buffer.GetString();
```



##